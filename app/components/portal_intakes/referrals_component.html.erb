<div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
  <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
    <h2 class="text-lg font-medium text-gray-900 dark:text-white"><%= title %></h2>
  </div>
  <div class="p-6">
    <div id="<%= container_id %>">
      <%= form.fields_for :portal_intake_referrals do |referral_form| %>
        <div class="referral-form border border-gray-200 rounded-lg p-4 mb-4 dark:border-gray-700">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-md font-medium text-gray-900 dark:text-white">Encaminhamento</h3>
            <button type="button" class="<%= remove_button_class %> text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">Remover</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CID</label>
              <%= referral_form.text_field :cid, placeholder: "Ex: F84.0", class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" %>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Encaminhado Para</label>
              <%= referral_form.select :encaminhado_para,
                  options_for_select([
                    ['Selecione...', ''],
                    ['ABA', 'ABA'],
                    ['FONO', 'FONO'],
                    ['TO', 'TO'],
                    ['PSICOPEDAGOGIA', 'PSICOPEDAGOGIA'],
                    ['PSICOLOGIA', 'PSICOLOGIA'],
                    ['PSICOMOTRICIDADE', 'PSICOMOTRICIDADE'],
                    ['FISIOTERAPIA', 'FISIOTERAPIA'],
                    ['EQUOTERAPIA', 'EQUOTERAPIA'],
                    ['MUSICOTERAPIA', 'MUSICOTERAPIA']
                  ], referral_form.object.encaminhado_para),
                  {},
                  class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" %>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Médico</label>
              <%= referral_form.text_field :medico, placeholder: "Nome do médico", class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" %>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CRM</label>
              <%= referral_form.text_field :medico_crm, placeholder: "Número do CRM", class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" %>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data de Encaminhamento</label>
              <%= referral_form.date_field :data_encaminhamento, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" %>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrição</label>
              <%= referral_form.text_area :descricao, rows: 3, placeholder: "Descrição do encaminhamento (opcional)", class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" %>
            </div>
          </div>
        </div>
      <% end %>
      <button type="button" id="<%= add_button_id %>" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-gray-500 hover:text-gray-700 hover:border-gray-400 dark:border-gray-600 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-500">
        <svg class="mx-auto h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        <span class="mt-2 block text-sm font-medium">Adicionar Encaminhamento</span>
      </button>
    </div>
  </div>
</div>

<script nonce="<%= content_security_policy_nonce %>">
(function() {
  function setupReferrals() {
    const addReferralBtn = document.getElementById('<%= add_button_id %>');
    const referralsContainer = document.getElementById('<%= container_id %>');
    if (!addReferralBtn || !referralsContainer) return;

    let referralIndex = Number(<%= @form.object.portal_intake_referrals.length %> || 0);

    if (!addReferralBtn.__referralsBound) {
      addReferralBtn.addEventListener('click', function() {
        const newReferral = createReferralForm(referralIndex);
        referralsContainer.insertBefore(newReferral, addReferralBtn);
        referralIndex++;
      });
      addReferralBtn.__referralsBound = true;
    }

    if (!referralsContainer.__referralsBound) {
      referralsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('<%= remove_button_class %>')) {
          e.target.closest('.referral-form').remove();
        }
      });
      referralsContainer.__referralsBound = true;
    }

    function createReferralForm(index) {
      const div = document.createElement('div');
      div.className = 'referral-form border border-gray-200 rounded-lg p-4 mb-4 dark:border-gray-700';
      div.innerHTML = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-md font-medium text-gray-900 dark:text-white">Encaminhamento</h3>
        <button type="button" class="<%= remove_button_class %> text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">Remover</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CID</label>
          <input type="text" name="portal_intake[portal_intake_referrals_attributes][${index}][cid]" placeholder="Ex: F84.0" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Encaminhado Para</label>
          <select name="portal_intake[portal_intake_referrals_attributes][${index}][encaminhado_para]" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">Selecione...</option>
            <option value="ABA">ABA</option>
            <option value="FONO">FONO</option>
            <option value="TO">TO</option>
            <option value="PSICOPEDAGOGIA">PSICOPEDAGOGIA</option>
            <option value="PSICOLOGIA">PSICOLOGIA</option>
            <option value="PSICOMOTRICIDADE">PSICOMOTRICIDADE</option>
            <option value="FISIOTERAPIA">FISIOTERAPIA</option>
            <option value="EQUOTERAPIA">EQUOTERAPIA</option>
            <option value="MUSICOTERAPIA">MUSICOTERAPIA</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Médico</label>
          <input type="text" name="portal_intake[portal_intake_referrals_attributes][${index}][medico]" placeholder="Nome do médico" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CRM</label>
          <input type="text" name="portal_intake[portal_intake_referrals_attributes][${index}][medico_crm]" placeholder="Número do CRM" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data de Encaminhamento</label>
          <input type="date" name="portal_intake[portal_intake_referrals_attributes][${index}][data_encaminhamento]" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrição</label>
          <textarea name="portal_intake[portal_intake_referrals_attributes][${index}][descricao]" rows="3" placeholder="Descrição do encaminhamento (opcional)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"></textarea>
        </div>
      </div>`;
      return div;
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupReferrals);
  } else {
    setupReferrals();
  }
  document.addEventListener('turbo:load', setupReferrals);
})();
</script>
