<% if current_user.admin? || current_user.permit?('beneficiary.tabs.chat.show') %>
  <%
    is_secretary = current_user.secretary? rescue false
    is_related_professional = false
    if current_user.professional.present?
      is_related_professional = beneficiary.professionals.exists?(id: current_user.professional.id) rescue false
    end

    can_access_general = current_user.admin? || is_secretary || is_related_professional || (current_user.respond_to?(:permit?) && current_user.permit?('beneficiary.tabs.secretary_access'))

    default_group = (is_related_professional && can_access_general) ? 'general' : 'professionals_only'
    selected_group = params[:chat_group].presence || default_group
    selected_group = 'professionals_only' unless %w[professionals_only general].include?(selected_group)

    conversation_professionals = ChatV2::UpsertConversation.call(
      service: 'beneficiaries',
      context_type: 'Beneficiary',
      context_id: beneficiary.id,
      scope: 'professionals_only',
      conversation_type: :group
    )

    conversation_general = can_access_general ? ChatV2::UpsertConversation.call(
      service: 'beneficiaries',
      context_type: 'Beneficiary',
      context_id: beneficiary.id,
      scope: 'general',
      conversation_type: :group
    ) : nil

    current_conversation = selected_group == 'general' ? conversation_general : conversation_professionals
  %>

  <% if current_conversation %>
    <div class="flex h-[600px] flex-col overflow-hidden rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
      <div class="sticky flex items-center justify-between border-b border-gray-200 px-5 py-4 dark:border-gray-800 xl:px-6">
        <div class="flex items-center gap-3">
          <div class="relative h-12 w-12 rounded-full bg-brand-500 flex items-center justify-center">
            <span class="text-white font-semibold text-lg"><%= beneficiary.name.first.upcase %></span>
          </div>
          <div>
            <h5 class="text-sm font-medium text-gray-800 dark:text-white/90"><%= beneficiary.name %></h5>
            <p class="text-xs text-gray-500 dark:text-gray-400">Chat do beneficiário</p>
          </div>
        </div>
        <div class="flex gap-2">
          <a href="<%= admin_beneficiary_path(beneficiary, tab: 'chat', chat_group: 'professionals_only') %>"
             class="px-3 py-1.5 text-xs font-medium rounded-lg transition <%= selected_group == 'professionals_only' ? 'bg-brand-500 text-white' : 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700' %>">
            Profissionais
          </a>
          <% if can_access_general && conversation_general %>
            <a href="<%= admin_beneficiary_path(beneficiary, tab: 'chat', chat_group: 'general') %>"
               class="px-3 py-1.5 text-xs font-medium rounded-lg transition <%= selected_group == 'general' ? 'bg-brand-500 text-white' : 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700' %>">
              Geral
            </a>
          <% end %>
        </div>
      </div>

      <div class="flex-1 overflow-hidden">
        <%= render ChatV2::MessageListComponent.new(
              conversation: current_conversation,
              current_user: current_user
            ) %>
      </div>

      <% if current_user.admin? || current_user.permit?('beneficiary.tabs.chat.edit') %>
        <div class="border-t border-gray-200 dark:border-gray-800">
          <%= render ChatV2::ComposerComponent.new(
                conversation: current_conversation,
                current_user: current_user
              ) %>
        </div>
      <% end %>
    </div>
  <% end %>
<% else %>
  <p class="text-sm text-gray-500 dark:text-gray-400">Você não tem permissão para visualizar o chat.</p>
<% end %>
