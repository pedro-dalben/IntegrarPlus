<div class="space-y-4">
  <% if current_user.permit?('beneficiary.tabs.tickets.show') %>
    <div class="space-y-3">
      <% tickets = beneficiary.beneficiary_tickets.includes(:assigned_professional, :created_by).order(created_at: :desc).limit(50) %>
      <% if tickets.any? %>
        <% tickets.each do |ticket| %>
          <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-800 dark:text-white"><%= ticket.title %></p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  Aberto por <%= ticket.created_by.full_name %> em <%= l(ticket.created_at, format: :short) %>
                </p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300">
                <%= ticket.status.humanize %>
              </span>
            </div>
            <% if ticket.assigned_professional.present? %>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Responsável: <%= ticket.assigned_professional.user.full_name %></p>
            <% end %>
            <% if ticket.description.present? %>
              <p class="text-sm text-gray-700 dark:text-gray-300 mt-2 whitespace-pre-wrap"><%= ticket.description %></p>
            <% end %>

            <% if current_user.permit?('beneficiary.tabs.tickets.edit') %>
              <div class="mt-3">
                <%= form_with model: [:admin, beneficiary, ticket], local: true do |f| %>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <%= f.select :status, BeneficiaryTicket.statuses.keys.map { |k| [k.humanize, k] }, {}, class: "dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 h-10 w-full rounded-lg border border-gray-300 bg-transparent px-3 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" %>
                    <%= f.collection_select :assigned_professional_id, Professional.joins(:user).order('users.full_name'), :id, ->(p){ p.user.full_name }, { include_blank: 'Sem responsável' }, class: "dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 h-10 w-full rounded-lg border border-gray-300 bg-transparent px-3 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" %>
                    <%= f.submit 'Atualizar', class: "bg-brand-500 shadow-theme-xs hover:bg-brand-600 inline-flex items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-white transition" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <p class="text-sm text-gray-500 dark:text-gray-400">Nenhum chamado.</p>
      <% end %>
    </div>

    <% if current_user.permit?('beneficiary.tabs.tickets.edit') %>
      <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
        <%= form_with url: admin_beneficiary_tickets_path(beneficiary), method: :post, local: true do |f| %>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <%= f.text_field :title, placeholder: "Título do chamado", class: "dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 h-10 w-full rounded-lg border border-gray-300 bg-transparent px-3 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" %>
            <%= f.text_area :description, rows: 2, placeholder: "Descrição (opcional)", class: "dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 w-full rounded-lg border border-gray-300 bg-transparent px-3 py-2 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" %>
            <%= f.submit "Criar chamado", class: "bg-brand-500 shadow-theme-xs hover:bg-brand-600 inline-flex items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-white transition" %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p class="text-sm text-gray-500 dark:text-gray-400">Você não tem permissão para visualizar os chamados.</p>
  <% end %>
</div>
