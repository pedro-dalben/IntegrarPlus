<% content_for(:title, "Visualizar Agenda - #{@agenda.name}") %>

<div class="mb-6">
  <div class="md:flex md:items-center md:justify-between">
    <div class="flex-1 min-w-0">
      <h2 class="text-2xl font-bold leading-7 text-gray-900 dark:text-white sm:text-3xl sm:truncate">
        Visualizar Agenda
      </h2>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        <%= @agenda.name %> - <%= @agenda.service_type.humanize %>
      </p>
    </div>
    <div class="flex items-center space-x-3">
      <%= link_to schedule_anamnesis_admin_portal_intake_path(@portal_intake), class: "ta-btn ta-btn-secondary" do %>
        <svg class="size-4 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Voltar ao Agendamento
      <% end %>
    </div>
  </div>
</div>

<div class="space-y-6">
  <!-- Informações da Agenda -->
  <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
      <h3 class="text-lg font-medium text-gray-900 dark:text-white">
        Informações da Agenda
      </h3>
    </div>
    <div class="p-6">
      <dl class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Nome</dt>
          <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100"><%= @agenda.name %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Tipo</dt>
          <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100"><%= @agenda.service_type.humanize %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Duração</dt>
          <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100"><%= @agenda.slot_duration_minutes %> minutos</dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Intervalo</dt>
          <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100"><%= @agenda.buffer_minutes %> minutos</dd>
        </div>
      </dl>

      <% if @selected_professional.present? %>
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
          <div class="flex items-center">
            <svg class="h-5 w-5 text-blue-400 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>
            <div>
              <h4 class="text-sm font-medium text-blue-900 dark:text-blue-100">Profissional Selecionado</h4>
              <p class="text-sm text-blue-700 dark:text-blue-300"><%= @selected_professional.full_name %></p>
            </div>
          </div>
        </div>
      <% else %>
        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-800">
          <div class="flex items-center">
            <svg class="h-5 w-5 text-yellow-400 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            <div>
              <h4 class="text-sm font-medium text-yellow-900 dark:text-yellow-100">Todos os Profissionais</h4>
              <p class="text-sm text-yellow-700 dark:text-yellow-300">Mostrando horários de todos os profissionais desta agenda</p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Profissionais -->
  <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
      <h3 class="text-lg font-medium text-gray-900 dark:text-white">
        Profissionais Disponíveis
      </h3>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <% @agenda.professionals.each do |professional| %>
          <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                <span class="text-sm font-medium text-white">
                  <%= professional.full_name.split.first[0] %>
                </span>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                <%= professional.full_name %>
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Disponível
              </p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Grade de Horários -->
  <div class="agenda-grid-content rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white">
          Grade de Horários
        </h3>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-green-100 border border-green-300 rounded"></div>
            <span class="text-xs text-gray-600 dark:text-gray-400">Disponível</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-blue-500 border border-blue-600 rounded"></div>
            <span class="text-xs text-gray-600 dark:text-gray-400">Selecionado</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-red-100 border border-red-300 rounded"></div>
            <span class="text-xs text-gray-600 dark:text-gray-400">Ocupado</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-gray-200 border border-gray-400 rounded"></div>
            <span class="text-xs text-gray-600 dark:text-gray-400">Passado</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-gray-100 border border-gray-300 rounded"></div>
            <span class="text-xs text-gray-600 dark:text-gray-400">Fora do horário</span>
          </div>
        </div>
      </div>
    </div>
    <div class="p-6">
      <!-- Navegação de Semana -->
      <div class="flex items-center justify-between mb-6">
        <button type="button" class="ta-btn ta-btn-secondary" data-action="click->agenda-grid#hideGrid">
          <svg class="size-4 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Fechar Grade
        </button>
      </div>

      <!-- Grade de Horários -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-800">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Horário
              </th>
              <% (0..6).each do |day| %>
                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  <%= I18n.t('date.day_names')[(Date.current.beginning_of_week + day.days).wday] %>
                  <br>
                  <span class="text-gray-400">
                    <%= (Date.current.beginning_of_week + day.days).strftime("%d/%m") %>
                  </span>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
            <% generate_time_slots.each_with_index do |time_slot, index| %>
              <tr class="<%= index.even? ? 'bg-white dark:bg-gray-900' : 'bg-gray-50 dark:bg-gray-800' %>">
                <td class="px-3 py-2 text-sm font-medium text-gray-900 dark:text-gray-100">
                  <%= time_slot %>
                </td>
                <% (0..6).each do |day| %>
                  <td class="px-3 py-2 text-center">
                    <%
                      current_date = Date.current.beginning_of_week + day.days
                      slot_datetime = Time.zone.parse("#{current_date} #{time_slot.split(' - ').first}")
                      is_available = is_slot_available?(slot_datetime, @selected_professional)
                      is_working_hour = is_working_hour?(current_date, time_slot)
                      is_past = is_past_slot?(slot_datetime)
                    %>
                    <% if is_working_hour %>
                      <% if is_past %>
                        <div class="w-full h-8 bg-gray-200 border border-gray-400 rounded flex items-center justify-center cursor-not-allowed">
                          <span class="text-xs font-medium text-gray-600">Passado</span>
                        </div>
                      <% elsif is_available %>
                        <button type="button"
                                class="slot-button w-full h-8 bg-green-100 hover:bg-green-200 border border-green-300 rounded text-xs font-medium text-green-800 transition-colors"
                                data-datetime="<%= slot_datetime.iso8601 %>"
                                data-time-slot="<%= time_slot %>"
                                onclick="handleSlotButtonClick(this, event)">
                          Livre
                        </button>
                      <% else %>
                        <div class="w-full h-8 bg-red-100 border border-red-300 rounded flex items-center justify-center">
                          <span class="text-xs font-medium text-red-800">Ocupado</span>
                        </div>
                      <% end %>
                    <% else %>
                      <div class="w-full h-8 bg-gray-100 border border-gray-300 rounded flex items-center justify-center">
                        <span class="text-xs font-medium text-gray-500">-</span>
                      </div>
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Agendamentos Existentes -->
  <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
      <h3 class="text-lg font-medium text-gray-900 dark:text-white">
        Agendamentos Existentes
      </h3>
    </div>
    <div class="p-6">
      <% if @existing_appointments.any? %>
        <div class="space-y-3">
          <% @existing_appointments.each do |appointment| %>
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
              <div class="flex items-center space-x-3">
                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                <div>
                  <p class="text-sm font-medium text-gray-900 dark:text-gray-100">
                    <%= appointment.scheduled_at.strftime("%d/%m/%Y às %H:%M") %>
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">
                    Profissional: <%= appointment.professional.full_name %>
                    <% if appointment.patient.present? %>
                      | Paciente: <%= appointment.patient.name %>
                    <% end %>
                  </p>
                </div>
              </div>
              <span class="text-xs text-gray-500 dark:text-gray-400">
                Ocupado
              </span>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <h3 class="mt-4 text-sm font-medium text-gray-900 dark:text-gray-100">
            Nenhum agendamento encontrado
          </h3>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
            <% if @selected_professional.present? %>
              Não há agendamentos para <%= @selected_professional.full_name %> nesta semana.
            <% else %>
              Não há agendamentos para esta agenda nesta semana.
            <% end %>
          </p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
function handleSlotButtonClick(button, event) {
  event.preventDefault();
  event.stopPropagation();

  const datetime = button.getAttribute('data-datetime');
  const timeSlot = button.getAttribute('data-time-slot');

  if (!datetime || !timeSlot) return;

  const professionalSelect = document.querySelector('select[name="professional_id"]');
  const professionalId = professionalSelect?.value;

  if (!professionalId) {
    alert('Por favor, selecione um profissional antes de escolher o horário.');
    return;
  }

  const previousButton = document.querySelector('.slot-selected');
  if (previousButton) {
    previousButton.classList.remove('slot-selected', 'bg-blue-500', 'border-blue-600', 'text-white');
    previousButton.classList.add('bg-green-100', 'hover:bg-green-200', 'border-green-300', 'text-green-800');
  }

  button.classList.remove('bg-green-100', 'hover:bg-green-200', 'border-green-300', 'text-green-800');
  button.classList.add('slot-selected', 'bg-blue-500', 'border-blue-600', 'text-white');

  const dateObj = new Date(datetime);
  const year = dateObj.getFullYear();
  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
  const day = String(dateObj.getDate()).padStart(2, '0');
  const dateString = `${year}-${month}-${day}`;
  const [timeString] = timeSlot.split(' - ');

  const dateInput = document.querySelector('[data-agenda-scheduler-target="dateSelect"]');
  const timeInput = document.querySelector('[data-agenda-scheduler-target="timeSelect"]');
  const datetimeSection = document.querySelector('[data-agenda-scheduler-target="datetimeSection"]');
  const previewSection = document.querySelector('[data-agenda-scheduler-target="previewSection"]');
  const submitButton = document.querySelector('[data-agenda-scheduler-target="submitButton"]');

  if (dateInput) dateInput.value = dateString;
  if (timeInput) timeInput.value = timeString;
  if (datetimeSection) datetimeSection.classList.remove('hidden');

  const scheduledDateTimeTarget = document.querySelector('[data-agenda-scheduler-target="scheduledDateTime"]');
  if (scheduledDateTimeTarget) {
    const formattedDate = new Date(dateString).toLocaleDateString('pt-BR');
    scheduledDateTimeTarget.textContent = `${formattedDate} às ${timeString}`;
  }

  if (previewSection) previewSection.classList.remove('hidden');
  if (submitButton) submitButton.disabled = false;
}
</script>
