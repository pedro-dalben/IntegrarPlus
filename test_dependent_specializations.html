<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sistema de Dependência</title>
    <script src="https://unpkg.com/@hotwired/stimulus@3.2.2/dist/stimulus.umd.js"></script>
    <script src="https://unpkg.com/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <link href="https://unpkg.com/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .debug { background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 20px; }
        .debug h3 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>Teste - Sistema de Dependência Especialidades/Especializações</h1>
    
    <div class="form-group">
        <label for="specialities">Especialidades:</label>
        <select id="specialities" multiple>
            <option value="1">Cardiologia</option>
            <option value="2">Neurologia</option>
            <option value="3">Ortopedia</option>
            <option value="4">Pediatria</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="specializations">Especializações:</label>
        <select id="specializations" multiple>
            <option value="">Selecione as especializações...</option>
        </select>
        <p><small>Especializações disponíveis baseadas nas especialidades selecionadas</small></p>
    </div>
    
    <div class="debug">
        <h3>Debug Console:</h3>
        <div id="debug-output"></div>
    </div>

    <script>
        // Simulação do controller Stimulus
        class DependentSpecializationsController {
            constructor() {
                this.specialitySelect = document.getElementById('specialities');
                this.specializationSelect = document.getElementById('specializations');
                this.debugOutput = document.getElementById('debug-output');
                
                this.init();
            }
            
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.debugOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                console.log(message);
            }
            
            init() {
                this.log('Controller inicializado');
                this.setupTomSelect();
                this.setupListeners();
            }
            
            setupTomSelect() {
                this.log('Configurando Tom Select para especialidades');
                
                this.specialityTomSelect = new TomSelect(this.specialitySelect, {
                    plugins: ['remove_button'],
                    placeholder: "Selecione as especialidades...",
                    maxItems: null,
                    create: false
                });
                
                this.log('Tom Select para especialidades configurado');
                
                this.log('Configurando Tom Select para especializações');
                
                this.specializationTomSelect = new TomSelect(this.specializationSelect, {
                    plugins: ['remove_button'],
                    placeholder: "Selecione as especializações...",
                    maxItems: null,
                    create: false
                });
                
                this.log('Tom Select para especializações configurado');
            }
            
            setupListeners() {
                this.log('Configurando listeners');
                
                this.specialityTomSelect.on('change', () => {
                    this.log('Evento change disparado no Tom Select de especialidades');
                    this.specialityChanged();
                });
                
                this.specialityTomSelect.on('item_add', () => {
                    this.log('Item adicionado ao Tom Select de especialidades');
                    this.specialityChanged();
                });
                
                this.specialityTomSelect.on('item_remove', () => {
                    this.log('Item removido do Tom Select de especialidades');
                    this.specialityChanged();
                });
                
                this.log('Listeners configurados com sucesso');
            }
            
            specialityChanged() {
                this.log('Especialidades alteradas, carregando especializações...');
                this.loadSpecializations();
            }
            
            async loadSpecializations() {
                const specialityIds = this.specialityTomSelect.getValue();
                this.log(`IDs das especialidades selecionadas: ${specialityIds}`);
                
                if (specialityIds.length === 0) {
                    this.log('Nenhuma especialidade selecionada, limpando especializações');
                    this.specializationTomSelect.clear();
                    this.specializationTomSelect.clearOptions();
                    this.specializationTomSelect.addOption({ value: '', text: 'Selecione as especializações...' });
                    return;
                }
                
                try {
                    this.log('Simulando requisição AJAX...');
                    
                    // Simulação de dados baseados nas especialidades selecionadas
                    const mockData = this.getMockSpecializations(specialityIds);
                    
                    this.log(`Dados recebidos: ${JSON.stringify(mockData)}`);
                    
                    this.specializationTomSelect.clear();
                    this.specializationTomSelect.clearOptions();
                    this.specializationTomSelect.addOption({ value: '', text: 'Selecione as especializações...' });
                    
                    mockData.forEach(spec => {
                        this.specializationTomSelect.addOption({
                            value: spec.id,
                            text: `${spec.name} (${spec.speciality_name})`
                        });
                    });
                    
                    this.log('Opções atualizadas com sucesso');
                    
                } catch (error) {
                    this.log(`Erro ao carregar especializações: ${error.message}`);
                    this.specializationTomSelect.clear();
                    this.specializationTomSelect.clearOptions();
                    this.specializationTomSelect.addOption({ value: '', text: 'Erro ao carregar especializações' });
                }
            }
            
            getMockSpecializations(specialityIds) {
                const allSpecializations = {
                    1: [ // Cardiologia
                        { id: 101, name: 'Cardiologia Intervencionista', speciality_name: 'Cardiologia' },
                        { id: 102, name: 'Eletrofisiologia Cardíaca', speciality_name: 'Cardiologia' },
                        { id: 103, name: 'Cardiologia Pediátrica', speciality_name: 'Cardiologia' }
                    ],
                    2: [ // Neurologia
                        { id: 201, name: 'Neurocirurgia', speciality_name: 'Neurologia' },
                        { id: 202, name: 'Neurologia Pediátrica', speciality_name: 'Neurologia' },
                        { id: 203, name: 'Neurofisiologia', speciality_name: 'Neurologia' }
                    ],
                    3: [ // Ortopedia
                        { id: 301, name: 'Ortopedia Pediátrica', speciality_name: 'Ortopedia' },
                        { id: 302, name: 'Traumatologia', speciality_name: 'Ortopedia' },
                        { id: 303, name: 'Cirurgia da Coluna', speciality_name: 'Ortopedia' }
                    ],
                    4: [ // Pediatria
                        { id: 401, name: 'Neonatologia', speciality_name: 'Pediatria' },
                        { id: 402, name: 'Cardiologia Pediátrica', speciality_name: 'Pediatria' },
                        { id: 403, name: 'Neurologia Pediátrica', speciality_name: 'Pediatria' }
                    ]
                };
                
                const result = [];
                specialityIds.forEach(id => {
                    if (allSpecializations[id]) {
                        result.push(...allSpecializations[id]);
                    }
                });
                
                return result;
            }
        }
        
        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', () => {
            new DependentSpecializationsController();
        });
    </script>
</body>
</html>
