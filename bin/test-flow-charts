#!/usr/bin/env bash
set -e

echo "ğŸ§ª Iniciando testes do mÃ³dulo de Fluxogramas..."
echo ""

echo "ğŸ“‹ Verificando prÃ©-requisitos..."

if ! command -v npx &> /dev/null; then
    echo "âŒ Node.js/npm nÃ£o encontrado. Por favor instale Node.js primeiro."
    exit 1
fi

if ! command -v bundle &> /dev/null; then
    echo "âŒ Bundler nÃ£o encontrado. Por favor instale Bundler primeiro."
    exit 1
fi

echo "âœ… Node.js encontrado"
echo "âœ… Bundler encontrado"
echo ""

if ! pgrep -f "rails server.*3001" > /dev/null; then
    echo "âš ï¸  Servidor Rails nÃ£o estÃ¡ rodando na porta 3001"
    echo "ğŸ“Œ Iniciando servidor de testes..."

    bin/rails server -p 3001 -e test &
    SERVER_PID=$!

    echo "â³ Aguardando servidor inicializar (15s)..."
    sleep 15

    echo "âœ… Servidor iniciado (PID: $SERVER_PID)"
    STOP_SERVER=true
else
    echo "âœ… Servidor Rails jÃ¡ estÃ¡ rodando"
    STOP_SERVER=false
fi

echo ""
echo "ğŸ§ª Executando testes Playwright..."
echo ""

npx playwright test tests/flow-charts.spec.ts --reporter=list

EXIT_CODE=$?

if [ "$STOP_SERVER" = true ]; then
    echo ""
    echo "ğŸ›‘ Parando servidor de testes..."
    kill $SERVER_PID 2>/dev/null || true
fi

echo ""
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… Todos os testes passaram com sucesso!"
    echo ""
    echo "ğŸ“Š Para ver o relatÃ³rio detalhado, execute:"
    echo "   npx playwright show-report"
else
    echo "âŒ Alguns testes falharam"
    echo ""
    echo "ğŸ” Para debug, execute:"
    echo "   npx playwright test tests/flow-charts.spec.ts --debug"
    echo ""
    echo "ğŸ“Š Para ver o relatÃ³rio, execute:"
    echo "   npx playwright show-report"
fi

echo ""
exit $EXIT_CODE
