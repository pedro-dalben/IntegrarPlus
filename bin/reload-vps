#!/bin/bash

echo "ğŸ”„ Recarregando IntegrarPlus na VPS..."

# Parar serviÃ§o
echo "â¹ï¸  Parando serviÃ§o..."
sudo systemctl stop integrarplus.service

# Atualizar cÃ³digo
echo "ğŸ“¥ Atualizando cÃ³digo do repositÃ³rio..."
git pull origin master

# Configurar ambiente
echo "âš™ï¸  Configurando ambiente..."
source ~/.rvm/scripts/rvm
export RAILS_ENV=production
source bin/setup-db

bundle lock --add-platform aarch64-linux
bundle install

# Executar seeds pendentes
echo "ğŸŒ± Executando seeds pendentes..."
bundle exec rails seeds:execute_pending || echo "âš ï¸  Nenhum seed pendente ou erro ao executar"

# Executar migrations
echo "ğŸ—„ï¸  Executando migrations..."
bundle exec rails db:migrate

# Recarregar assets
echo "ğŸ¨ Recarregando assets..."
bundle exec rails assets:clobber assets:precompile
bundle exec vite build
bin/setup-assets

# Reindexar MeiliSearch
echo "ğŸ” Reindexando MeiliSearch..."
bundle exec rails meilisearch:reindex

# Reiniciar serviÃ§o
echo "ğŸš€ Reiniciando serviÃ§o..."
sudo systemctl start integrarplus.service

# Aguardar um pouco
sleep 3

# Verificar status
echo "âœ… Verificando status..."
sudo systemctl status integrarplus.service --no-pager -l

echo ""
echo "ğŸ‰ Recarregamento concluÃ­do!"
echo "ğŸ“± Acesse: http://localhost:3001"
echo "ğŸ“ Logs: sudo journalctl -u integrarplus.service -f"
